# Environment Setup Guide

## Overview

This guide explains how to properly configure environment variables for both web and APK builds in the CrewVar application.

## Problem

Capacitor APK builds do not automatically expose `.env` variables to the native build, causing Google OAuth authentication to fail on mobile devices.

## Solution

We've implemented a centralized OAuth configuration system that handles both web and mobile environments.

## Required Environment Variables

### For Web Development

Create a `.env.local` file in the project root:

```env
# Firebase Configuration
VITE_FIREBASE_API_KEY=your_firebase_api_key
VITE_FIREBASE_AUTH_DOMAIN=your_project.firebaseapp.com
VITE_FIREBASE_PROJECT_ID=your_project_id
VITE_FIREBASE_STORAGE_BUCKET=your_project.appspot.com
VITE_FIREBASE_MESSAGING_SENDER_ID=your_sender_id
VITE_FIREBASE_APP_ID=your_app_id
VITE_FIREBASE_DATABASE_URL=https://your_project.firebaseio.com

# Google OAuth Configuration (Web)
VITE_GOOGLE_CLIENT_ID=your_web_google_client_id
VITE_GOOGLE_CLIENT_SECRET=your_web_google_client_secret
```

### For APK Builds

APK builds use hardcoded values in `src/config/oauth.ts`. You need to update these values:

```typescript
export const GOOGLE_OAUTH_CONFIG = {
  // Update these values for your Android app
  ANDROID_CLIENT_ID: "your_android_client_id",
  ANDROID_CLIENT_SECRET: "your_android_client_secret",
  // ... other config
};
```

## Google OAuth Setup

### 1. Create Google OAuth Credentials

1. Go to [Google Cloud Console](https://console.cloud.google.com)
2. Select your project
3. Go to "APIs & Services" > "Credentials"
4. Create OAuth 2.0 Client IDs for:
   - **Web application** (for web builds)
   - **Android application** (for APK builds)

### 2. Android OAuth Setup

For Android APK, you need:

1. **Package name**: `com.crewvar.app`
2. **SHA-1 certificate fingerprint**: Get from your keystore
3. **Client ID**: Generated by Google Console
4. **Client Secret**: Generated by Google Console

### 3. Get SHA-1 Fingerprint

```bash
# For debug keystore
keytool -list -v -keystore ~/.android/debug.keystore -alias androiddebugkey -storepass android -keypass android

# For release keystore
keytool -list -v -keystore path/to/your/release.keystore -alias your_alias
```

### 4. Update Configuration

Update `src/config/oauth.ts` with your Android credentials:

```typescript
export const GOOGLE_OAUTH_CONFIG = {
  ANDROID_CLIENT_ID: "your_android_client_id_here",
  ANDROID_CLIENT_SECRET: "your_android_client_secret_here",
  // ... rest of config
};
```

## Testing

### Web Testing

1. Set up `.env.local` with web credentials
2. Run `npm run dev`
3. Test Google OAuth in browser

### APK Testing

1. Update `src/config/oauth.ts` with Android credentials
2. Build APK: `npm run android:build`
3. Install APK on device
4. Test Google OAuth in APK

## Debugging

### Check OAuth Configuration

The app automatically logs OAuth configuration on startup:

```typescript
// This runs automatically
debugOAuthConfig();
```

Look for logs like:

```
=== OAuth Configuration Debug ===
Platform: android
Client ID: ✅ Set
Client Secret: ✅ Set
Redirect URI: com.crewvar.app:/auth/google-callback
Validation: ✅ Valid
================================
```

### Common Issues

1. **Client Secret Missing**: Update `ANDROID_CLIENT_SECRET` in `oauth.ts`
2. **Wrong Package Name**: Ensure package name matches Google Console
3. **SHA-1 Mismatch**: Update SHA-1 fingerprint in Google Console
4. **Redirect URI Mismatch**: Ensure redirect URI matches exactly

## Security Notes

- **Never commit** `.env.local` files to version control
- **Client secrets** are embedded in APK builds (this is normal for mobile apps)
- **Use different credentials** for development and production
- **Rotate secrets** regularly for security

## File Structure

```
src/
├── config/
│   └── oauth.ts          # Centralized OAuth configuration
├── components/auth/
│   ├── GlobalDeepLinkHandler.tsx
│   ├── GoogleAuthWebView.tsx
│   └── DeepLinkHandler.tsx
└── pages/auth/
    └── GoogleAuthCallback.tsx
```

## Migration from Old System

The old system used environment variables directly. The new system:

1. **Centralizes** OAuth configuration
2. **Handles** web vs mobile differences
3. **Validates** configuration before use
4. **Provides** better error messages
5. **Prevents** duplicate processing

## Support

If you encounter issues:

1. Check the debug logs for OAuth configuration
2. Verify Google Console settings
3. Ensure SHA-1 fingerprint is correct
4. Test with both web and APK builds

